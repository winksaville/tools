machine:
  environment:
    REQUESTED_PYTHON_VER: 3.5.1
    INSTALL_PREFIX_DIR_HOME_REL: ~/opt
    INSTALL_PREFIX_DIR: ${HOME}/opt
    PATH: ${INSTALL_PREFIX_DIR}/bin:${INSTALL_PREFIX_DIR}/x-tools/x86_64-unknown-elf/bin:${INSTALL_PREFIX_DIR}/x-tools/i386-unknown-elf/bin:${INSTALL_PREFIX_DIR}/x-tools/arm-unknown-eabi/bin:${INSTALL_PREFIX_DIR}/Python-${REQUESTED_PYTHON_VER}/bin:${PATH}

  #python:
  #  version: 3.5.0

  pre:
    # Needed by test.sh
    - sudo apt-get install realpath

    # Needed to compile ninja
    - sudo apt-get install re2c

    # Neadded to compile binutils-gdb
    - sudo apt-get install texinfo

    # Needed to compile gcc native compiler
    - sudo apt-get install libgmp-dev libmpfr-dev libmpc-dev

    # Needed to compile crosstool-ng
    - sudo apt-get install gperf help2man

    # Install gcc/g++ 5 because options -Wpednatic and -std
    # are not in older compilers and they generate unknown
    # command line option errors. The update-alternatives
    # makes the compilers the default.
    - sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
    - sudo apt-get update; sudo apt-get install gcc-5; sudo apt-get install g++-5
    - sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-5 100
    - sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-5 100

checkout:
  post:
    # Update the submodules
    - git submodule sync --recursive
    - git submodule update --recursive --init

dependencies:
  cache_directories:
    #- ${INSTALL_PREFIX_DIR_HOME_REL} # This doesn't work.
    #- ~/opt

  pre:
    # Default to python 3.5.1, needed because subprocess.run is used in vendor-install-tools
    # REQUESTED_PYTHON_VER set above
    - ./python_install.sh
    - which python
    - python --version
    - which python2
    - python2 --version
    - which python3
    - python3 --version
    - which virtualenv
    - virtualenv --version

  post:
    # Install the tools we need
    - ./install.py meson --installPrefixDir=${INSTALL_PREFIX_DIR}
    - ./install.py ninja --installPrefixDir=${INSTALL_PREFIX_DIR}
      #- ./install.py binutils-arm-eabi --installPrefixDir=${INSTALL_PREFIX_DIR}
      # - ./install.py gcc-arm-eabi --installPrefixDir=${INSTALL_PREFIX_DIR}
      #- ./install.py binutils-i586-elf --installPrefixDir=${INSTALL_PREFIX_DIR}
      # - ./install.py gcc-i586-elf --installPrefixDir=${INSTALL_PREFIX_DIR}
    - ./install.py ct-ng --installPrefixDir=${INSTALL_PREFIX_DIR}
    - ./install.py gcc-x86_64 --installPrefixDir=${INSTALL_PREFIX_DIR}
    - ./install.py gcc-i386 --installPrefixDir=${INSTALL_PREFIX_DIR}
    - ./install.py gcc-arm --installPrefixDir=${INSTALL_PREFIX_DIR}
    - ./install.py qemu-system-arm --installPrefixDir=${INSTALL_PREFIX_DIR}

test:
  pre:
    - ./test.sh quick

  override:
    - ./test.sh force_install

  post:
    - ./test.sh quick
